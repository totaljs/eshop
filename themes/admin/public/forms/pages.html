<div data-jc="form__common.form__icon:file-text-o;if:pages-form;width:1500;reload:pagesform/show;submit:pagesform/submit;autofocus:true" class="hidden">
	<div class="padding" style="padding-bottom:10px">
		<div class="row">
			<div class="col-md-3 m">
				<div data-jc="textbox__pages.form.name__placeholder:@(Homepage);required:true">@(Name)</div>
				<div data-jc="checkbox__pages.form.ispartial" class="green b mt10">@(Is a partial content)</div>
			</div>
			<div class="col-md-3 m">
				<div data-jc="textbox__pages.form.url__icon:globe;placeholder:@(Page relative URL address);required:true">@(URL address)</div>
			</div>
			<div class="col-md-3 m">
				<div data-jc="disable__pages.form.lockedtemplate__if:value === true">
					<div data-jc="dropdown__pages.form.template__datasource:common.dependencies.templatespages;empty:">@(Template)</div>
				</div>
				<div data-bind="pages.form.lockedtemplate__show:!value || user.sa">
					<div data-jc="checkbox__pages.form.lockedtemplate2" class="red b mt10">@(Lock this template for editors)</div>
				</div>
			</div>
			<div class="col-md-3 m" data-jc="disable__pages.form.ispartial__if:value">
				<div data-jc="dropdown__pages.form.parent__datasource:pages.parents;empty:;icon:sitemap">@(Parent)</div>
				<div class="help">@(Affects sitemap and breadcrumb.)</div>
			</div>
		</div>
	</div>
	<div data-bind="pages.form.draft__show:value" class="hidden fs11" style="padding:8px 20px;background-color:red;color:white"><a href="javascript:void(0)" style="color:white;float:right" class="exec" data-exec="pagesform/removedraft"><i class="fa fa-times-circle mr5"></i>@(Remove draft)</a><i class="fa fa-warning mr5"></i>@(Page <b>content</b> is in draft mode).</div>
	<div class="cmseditor" data-jc="cmseditor__pages.form.body" data-jc-import="[url]components/cmseditor.html"></div>
	<div class="backups hidden hidden-xs bg-smoke" data-bind="pages.form.id__show:!!value">
		<div class="hidden" data-bind="pages.form.id__show:value">
			<div data-jc="checkbox__pages.form.draft" class="nmb red b" data-bind="pages.form.lockedcontent__show:!value">@(DRAFT)</div>
		</div>
		<div class="hidden" data-bind="user.sa__show:value">
			<div data-jc="checkbox__pages.form.lockedcontent" class="nmb b">@(LOCK)</div>
		</div>
		<div class="hidden" data-bind="user.sa__show:value">
			<div data-jc="checkbox__pages.form.usedefault" class="nmb b">@(DEFAULT CONTENT)</div>
		</div>
		<div class="hidden" data-bind="pages.form.lockedcontent__show:!value">
			<a href="javascript:void(0)" class="exec inline green" data-exec="cmseditor.instance.editCSS"><i class="fa fa-paint-brush mr5"></i>@(Edit page styles)</a>
		</div>
		<div class="hidden" data-bind="pages.form.lockedcontent__show:!value">
			<a href="javascript:void(0)" class="exec inline" data-exec="pagesform/backups"><i class="fa fa-clock-o mr5"></i>@(Restore a backup)</a>
		</div>
		<a href="javascript:void(0)" class="exec red" data-exec="pagesform/submit" style="float:right"><i class="fa fa-floppy-o mr5"></i>@(Save settings)</a>
		<a href="javascript:void(0)" data-bind="pages.form.url__href:pagesform/preview" target="_blank" class="mr10" style="float:right" title="@(Preview saved content)"><i class="fa fa-search mr5"></i>@(Preview)</a>
	</div>
	<div class="padding">
		<div class="row mt10">
			<div class="col-md-4 m">
				<div data-jc="textbox__pages.form.title__maxlength:50">@(Title)</div>
				<div class="help">@(Meta title, maximum 60 chars.)</div>
			</div>
			<div class="col-md-4">
				<div data-jc="textbox__pages.form.description__icon:align-center;maxlength:120">@(Description)</div>
				<div class="help">@(Meta description, maximum 120 chars.)</div>
			</div>
			<div class="col-md-4 m">
				<div data-jc="textbox__pages.form.keywords__icon:tags;maxlength:80;placeholder:@(company, our team, employees)">@(Keywords)</div>
				<div class="help">@(Meta keywords, maximum 6 words seperated by comma.)</div>
			</div>
		</div>
		<div class="row mt10">
			<div class="col-md-4 m">
				<div data-jc="textboxlist__pages.form.redirects__icon:retweet;placeholder:@(Add a relative URL address and press enter)">@(Redirects)</div>
				<div class="help">@(URL address for redirecting to this page e.g. <code>/products/</code>)</div>
			</div>
			<div class="col-md-4 m">
				<div data-jc="dropdowncheckbox__pages.form.navigations__alltext:null;datasource:common.dependencies.navigations;empty:@(Doesn't contain any navigations.);icon:navicon;cleaner:false">@(Side navigations)</div>
				<div class="help">@(Add side navigations.)</div>
			</div>
			<div class="col-md-2 m">
				<div data-jc="dropdown__pages.form.language__icon:flag;datasource:common.dependencies.languages;empty:">@(Language)</div>
			</div>
		</div>
	</div>
	<div class="padding bg-yellow">
		<div class="row">
			<div class="col-md-8">
				<div class="row">
					<div class="col-md-6 m">
						<div data-jc="dropdowncheckbox__pages.form.signals__alltext:null;datasource:common.dependencies.signals;empty:@(Doesn't contain any signals.);icon:dot-circle-o">@(Signals)</div>
						<div class="help">@(Signals can start special actions when the page is displayed.)</div>
					</div>
					<div class="col-md-6 m">
						<div data-jc="dropdowncheckbox__pages.form.partial__alltext:null;datasource:pages.partial;empty:@(Doesn't contain any partial pages.);icon:database;cleaner:false">@(Nested partial pages)</div>
						<div class="help">@(Join other partial pages with this.)</div>
					</div>
				</div>
				<hr />
				<div class="b"><i class="fa fa-cog mr5"></i>@(Settings for navigations)</div>
				<div style="margin-top:8px">
					<div data-jc="checkbox__pages.form.navicon" class="inline mr10">@(Replace icon in all navigations)</div>
					<div data-jc="checkbox__pages.form.navname" class="inline mr10">@(Replace name and language in all navigations)</div>
					<div data-jc="checkbox__pages.form.replacelink" class="inline">@(Replace older URL in the whole content)</div>
				</div>
			</div>
			<div class="col-md-4">
				<div class="fs12"><i class="fab fa-fa mr5"></i>@(Choose icon):</div>
				<div class="mt5" data-jc="fontawesomebox__pages.form.icon__search:@(Search icons);height:160"></div>
			</div>
		</div>
	</div>
	<div data-bind="pages.form.id__show:value && value.length" class="hidden">
		<hr class="nmt" />
		<div class="padding">
			<div class="row">
				<div class="col-lg-2 col-md-3 m">
					<div class="keyvalue">
						<div class="key">@(# Id)</div>
						<div class="value" data-bind="pages.form.id__html:value"></div>
					</div>
				</div>
				<div class="col-lg-2 col-md-3 m">
					<div class="keyvalue">
						<div class="key"><i class="fa fa-calendar"></i>@(Created)</div>
						<div class="value" data-bind="pages.form.datecreated__html:Thelpers.time(value)"></div>
					</div>
				</div>
				<div class="col-lg-2 col-md-3 m">
					<div class="keyvalue">
						<div class="key"><i class="fa fa-calendar"></i>@(Updated)</div>
						<div class="value" data-bind="pages.form.dateupdated__html:value ? Thelpers.time(value) : '@(unchanged)'"></div>
					</div>
				</div>
				<div class="col-lg-6 m" data-bind="pages.form.stats__show:value">
					<div data-jc="nosqlcounter__pages.form.stats__height:52"></div>
					<div class="help"><i class="fa fa-chart-bar"></i>@(Stats of all views for the last period)</div>
				</div>
			</div>
		</div>
	</div>
	<div data-jc="error__pages.form.response"></div>
	<div class="ui-form-buttons" data-jc="validation__pages.form">
		<button name="cancel">@(Cancel)</button>
		<button name="submit">@(SAVE)</button>
	</div>
</div>

<script>

	PLUGIN('pagesform', function(exports) {

		exports.scope = 'pages';

		if (user.sa) {
			WATCH('pages.form.lockedtemplate2', function(path, value, type) {
				type === 2 && SET('pages.form.lockedtemplate', value);
			});

			WATCH('pages.form.lockedcontent', function(path, value, type) {
				value && SET('pages.form.draft', false);
				cmseditor.instance.lock(value);
			});
		}

		WATCH('pages.form.draft', function(path, value, type) {
			type === 2 && BIND('pages.form.url');
		});

		exports.preview = function(value) {
			return value + (pages.form && pages.form.draft ? '?DRAFT=1' : '');
		};

		exports.removedraft = function() {
			SETTER('confirm', 'show', '@(Are you sure you want to remove stored draft?)', ['"trash-o" @(Yes)', '@(Cancel)'], function(index) {
				if (!index) {
					SET('pages.form.body', pages.form.bodycurrent);
					SET('pages.form.draft', false);
					cmseditor.instance.setWidgetOptions(pages.form.widgets);
				}
			});
		};

		exports.show = function(com) {

			var model = pages.form;
			var items = pages.list;
			var parent = [];
			var partial = [];

			com.reconfigure({ title: model.id ? '@(Edit page)' : '@(New page)' });

			for (var i = 0, length = items.length; i < length; i++) {
				var item = items[i];
				if (item.id !== model.id) {
					if (item.ispartial)
						partial.push({ id: item.id, name: item.name });
					else
						parent.push({ id: item.id, name: item.name, url: item.url });
				}
			}

			SET('pages.partial', partial);
			SET('pages.parents', parent);
			SET('pages.form.lockedtemplate2', !!model.lockedtemplate, true);

			WAIT('cmseditor.instance', function() {
				cmseditor.instance.setWidgetOptions(model.draft ? model.dwidgets : model.widgets);
				cmseditor.instance.lock(!!model.lockedcontent);
			});

			model.id && AJAX('GET [url]api/{0}/{1}/stats/'.format(exports.scope, model.id), exports.scope + '.form.stats');
			SETTER('loading', 'hide', 1000);
		};

		exports.submit = function(com) {

			var model = CLONE(pages.form);
			var editor = cmseditor.instance;

			model.pictures = editor.getPictures();
			model.summary = editor.getSummary();
			model.body = editor.getContent().replace(/(\r)?\n[\s\t]+(\r)?\n/g, '\n');
			model.search = editor.getKeywords();
			model.bodydraft = undefined;
			model.bodyraw = undefined;

			var w = editor.getWidgets();
			model.widgets = w.settings;
			model.bodywidgets = w.widgets;

			var locked = model.lockedtemplate2 === true;
			model.lockedtemplate = locked;
			model.lockedtemplate2 = undefined;

			if (model.ispartial) {
				model.navigations = null;
				model.partial = null;
				model.parent = '';
			}

			if (model.usedefault) {
				model.widgets = [];
				model.bodywidgets = [];
				model.body = '';
			}

			model.stats = undefined;
			model.css = cmseditor.css;

			var submit = function() {
				var parts = { type: 'page', items: editor.getParts() };
				SETTER('loading', 'show');
				AJAX('POST [url]api/{0}/ REPEAT'.format(exports.scope), model, function(response) {
					SETTER('loading', 'hide', 1000);
					if (response.success) {
						SETTER('snackbar', 'success', '@(Page has been saved successfully.)');

						if (com && !(com instanceof jQuery))
							com.hide();
						else
							SET('pages.form.lockedtemplate', locked);

						EXEC('pages/refresh');

						// Updates parts
						parts.idowner = response.value;
						AJAX('POST [url]api/parts/', parts, NOOP);
					}
				});
			};

			if (model.lockedtemplate && !user.sa) {
				SETTER('confirm', 'show', '@(Are you sure you want to use always this template?)', ['@(Sure)', '@(No)'], function(index) {
					!index && submit();
				});
			} else
				submit();
		};

		exports.backups = function(el) {

			SETTER('loading', 'show');
			AJAX('GET [url]api/{0}/{1}/backups/'.format(exports.scope, GET('pages.form.id')), function(response) {

				SETTER('loading', 'hide', 1000);

				for (var i = 0, length = response.length; i < length; i++) {
					var item = response[i];
					item.name = '{0} <b class="badge badge-blue ml5"><i class="fa fa-user mr5"></i>{1}</b>'.format(item.date.format('@(dd. MMM yyyy - HH:mm)'), item.user);
				}

				response.quicksort('date', false);

				SETTER('suggestion', 'show', 'left', el, response, function(value) {
					SETTER('loading', 'show');
					setTimeout(function() {
						cmseditor.instance.replace(value.data.body);
						SETTER('loading', 'hide', 1000);
					}, 100);
				});
			});
		};

		WATCH('pages.form.draft', function(path, value) {



		}, true);

		WATCH('pages.form.template', function(path, value, type) {

			if (type === 2) {
				cmseditor.instance.reconfigure('template:' + value);
				cmseditor.instance.set('');
			}

		}, true);
	});

</script>
